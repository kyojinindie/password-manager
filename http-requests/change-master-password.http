###
# F6: Change Master Password - HTTP Request Examples
#
# This file contains example HTTP requests for testing the Change Master Password feature.
# Use with REST Client extension in VS Code or any HTTP client.
###

### Variables
@baseUrl = http://localhost:3000
@accessToken = your-access-token-here

###
# 1. Change Master Password (Success)
#
# Prerequisites:
# - User must be logged in (have valid access token)
# - Current password must be correct
# - New password must meet complexity requirements
# - New password must be different from current password
#
# Expected Response: 200 OK
# {
#   "userId": "uuid",
#   "passwordEntriesReEncrypted": 42,
#   "changedAt": "2025-01-15T10:30:00.000Z"
# }
###
PUT {{baseUrl}}/auth/password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentMasterPassword": "CurrentSecurePass123!",
  "newMasterPassword": "NewSecurePass456!"
}

###
# 2. Change Master Password - Missing Authentication
#
# Expected Response: 401 Unauthorized
# {
#   "error": "Unauthorized",
#   "message": "Authentication required. Please provide a valid access token."
# }
###
PUT {{baseUrl}}/auth/password
Content-Type: application/json

{
  "currentMasterPassword": "CurrentSecurePass123!",
  "newMasterPassword": "NewSecurePass456!"
}

###
# 3. Change Master Password - Wrong Current Password
#
# Expected Response: 401 Unauthorized
# {
#   "error": "Unauthorized",
#   "message": "Current master password is incorrect"
# }
###
PUT {{baseUrl}}/auth/password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentMasterPassword": "WrongPassword123!",
  "newMasterPassword": "NewSecurePass456!"
}

###
# 4. Change Master Password - Missing Current Password
#
# Expected Response: 400 Bad Request
# {
#   "error": "Bad Request",
#   "message": "Current master password is required"
# }
###
PUT {{baseUrl}}/auth/password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "newMasterPassword": "NewSecurePass456!"
}

###
# 5. Change Master Password - Missing New Password
#
# Expected Response: 400 Bad Request
# {
#   "error": "Bad Request",
#   "message": "New master password is required"
# }
###
PUT {{baseUrl}}/auth/password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentMasterPassword": "CurrentSecurePass123!"
}

###
# 6. Change Master Password - Same Password
#
# Expected Response: 400 Bad Request
# {
#   "error": "Bad Request",
#   "message": "New password must be different from current password"
# }
###
PUT {{baseUrl}}/auth/password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentMasterPassword": "CurrentSecurePass123!",
  "newMasterPassword": "CurrentSecurePass123!"
}

###
# 7. Change Master Password - Weak New Password
#
# Expected Response: 400 Bad Request
# {
#   "error": "Bad Request",
#   "message": "Password must be at least 8 characters long and contain..."
# }
###
PUT {{baseUrl}}/auth/password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentMasterPassword": "CurrentSecurePass123!",
  "newMasterPassword": "weak"
}

###
# 8. Complete Flow: Login -> Change Password
#
# Step 1: Login to get access token
###
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "masterPassword": "SecurePass123!"
}

###
# Step 2: Use the access token from login response to change password
###
PUT {{baseUrl}}/auth/password
Authorization: Bearer <copy-access-token-from-login-response>
Content-Type: application/json

{
  "currentMasterPassword": "SecurePass123!",
  "newMasterPassword": "NewSecurePass456!"
}

###
# Step 3: Login with new password to verify change
###
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "masterPassword": "NewSecurePass456!"
}

###
# Notes:
#
# 1. AUTHENTICATION REQUIRED:
#    - This endpoint requires a valid JWT access token
#    - The token must be included in the Authorization header
#    - Format: "Bearer <token>"
#
# 2. USER CONTEXT:
#    - The userId is extracted from the JWT token
#    - Users can only change their own password
#    - The authentication middleware must populate req.user.userId
#
# 3. PASSWORD REQUIREMENTS:
#    - Must be different from current password
#    - Must meet complexity requirements (domain validation)
#    - Typical requirements: min length, uppercase, lowercase, numbers, special chars
#
# 4. RE-ENCRYPTION:
#    - All password entries are re-encrypted with the new master password
#    - This operation is atomic (all or nothing)
#    - May take time for users with many password entries
#    - The response includes the count of re-encrypted entries
#
# 5. SECURITY:
#    - Current password verification prevents unauthorized changes
#    - JWT token ensures only authenticated users can change password
#    - Failed attempts are logged for security monitoring
#
# 6. ERROR HANDLING:
#    - 400: Bad request (missing fields, invalid format, same password)
#    - 401: Unauthorized (wrong current password, missing token)
#    - 404: User not found (shouldn't happen with valid token)
#    - 500: Server error (re-encryption failure, database issues)
###
